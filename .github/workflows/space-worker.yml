name: Space Worker

on:
  workflow_dispatch:
    inputs:
      space_url:
        description: 'X/Twitter Space URL (optional if JSONL paths provided)'
        required: false
        type: string
        default: ''
      base:
        description: 'Base slug for filenames (default derived from URL or timestamp)'
        required: false
        type: string
        default: ''
      jsonl_path:
        description: 'Path to crawl JSONL (speech+events). If empty, uses artifacts/<base>.jsonl'
        required: false
        type: string
        default: ''
      replies_jsonl:
        description: 'Path to replies JSONL (tweet replies). If empty, uses artifacts/<base>_replies.jsonl if present'
        required: false
        type: string
        default: ''
      purple_tweet_url:
        description: 'URL of the Purple Pill tweet (enables embeds)'
        required: false
        type: string
        default: ''
      post_id:
        description: 'WordPress post ID to update (optional)'
        required: false
        type: string
        default: ''
      gcs_prefix:
        description: 'GCS prefix like spaces/2025/11 (optional)'
        required: false
        type: string
        default: ''
      mode:
        description: 'What to run'
        required: true
        type: choice
        options: [full, replies-only, transcripts-only]
        default: full
      upload_artifacts:
        description: 'Upload GitHub artifact bundle'
        required: true
        type: boolean
        default: true
      publish_wp:
        description: 'Publish results to WordPress if post_id provided'
        required: true
        type: boolean
        default: false

concurrency:
  group: space-worker-${{ github.ref }}-${{ github.event.inputs.base || github.run_id }}
  cancel-in-progress: true

permissions:
  contents: read
  id-token: write  # only used if uploading to GCS

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      ARTDIR: artifacts
      # Secrets (optional)
      WP_BASE_URL: ${{ secrets.WP_BASE_URL }}
      WP_USER: ${{ secrets.WP_USER }}
      WP_APP_PASSWORD: ${{ secrets.WP_APP_PASSWORD }}
      GCS_BUCKET: ${{ secrets.GCS_BUCKET }}
      GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
      # X/Twitter cookies/tokens if your crawler uses them (scripts here do not fetch network)
      TWITTER_AUTHORIZATION: ${{ secrets.TWITTER_AUTHORIZATION }}
      TWITTER_AUTH_TOKEN: ${{ secrets.TWITTER_AUTH_TOKEN }}
      TWITTER_CSRF_TOKEN: ${{ secrets.TWITTER_CSRF_TOKEN }}
      TW_API_CONSUMER_KEY: ${{ secrets.TW_API_CONSUMER_KEY }}

    outputs:
      base: ${{ steps.init.outputs.base }}
      vtt_path: ${{ steps.outputs.outputs_vtt_path }}
      emoji_vtt_path: ${{ steps.outputs.outputs_emoji_vtt_path }}
      transcript_path: ${{ steps.outputs.outputs_transcript_path }}
      transcript_clean_path: ${{ steps.outputs.outputs_transcript_clean_path }}
      replies_path: ${{ steps.outputs.outputs_replies_path }}
      links_path: ${{ steps.outputs.outputs_links_path }}
      gcs_base_url: ${{ steps.gcs.outputs.gcs_base_url }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install tldextract

      - name: Initialize workspace and derive BASE
        id: init
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "$ARTDIR"
          BASE_IN="${{ inputs.base }}"
          SPACE_URL="${{ inputs.space_url }}"
          if [ -n "$BASE_IN" ]; then
            BASE="$BASE_IN"
          elif [[ "$SPACE_URL" =~ status/([0-9]+) ]]; then
            BASE="space-${BASH_REMATCH[1]}"
          else
            BASE="space-$(date -u +%Y%m%d-%H%M%S)"
          fi
          echo "BASE=$BASE" >> "$GITHUB_ENV"
          echo "base=$BASE" >> "$GITHUB_OUTPUT"

          JSONL_PATH_IN="${{ inputs.jsonl_path }}"
          REPLIES_JSONL_IN="${{ inputs.replies_jsonl }}"
          JSONL_PATH="${JSONL_PATH_IN:-$ARTDIR/$BASE.jsonl}"
          REPLIES_JSONL="${REPLIES_JSONL_IN:-$ARTDIR/${BASE}_replies.jsonl}"

          echo "JSONL_PATH=$JSONL_PATH" >> "$GITHUB_ENV"
          echo "REPLIES_JSONL=$REPLIES_JSONL" >> "$GITHUB_ENV"
          echo "PURPLE_TWEET_URL=${{ inputs.purple_tweet_url }}" >> "$GITHUB_ENV"

          # Touch placeholder files if paths were not provided and do not exist
          [ -f "$JSONL_PATH" ] || : > "$JSONL_PATH"
          [ -f "$REPLIES_JSONL" ] || : > "$REPLIES_JSONL"

      - name: List inputs and environment
        run: |
          echo "Mode: ${{ inputs.mode }}"
          echo "BASE: $BASE"
          echo "JSONL_PATH: $JSONL_PATH"
          echo "REPLIES_JSONL: $REPLIES_JSONL"
          echo "ARTDIR: $ARTDIR"

      - name: Generate captions/emoji VTT + transcript
        if: ${{ inputs.mode != 'replies-only' }}
        shell: bash
        run: |
          set -euo pipefail
          python ".github/workflows/scripts/gen_vtt.py"

      - name: Polish transcript HTML
        if: ${{ inputs.mode != 'replies-only' }}
        shell: bash
        run: |
          set -euo pipefail
          python ".github/workflows/scripts/polish_transcript.py"

      - name: Build replies HTML + links
        if: ${{ inputs.mode != 'transcripts-only' }}
        shell: bash
        run: |
          set -euo pipefail
          python ".github/workflows/scripts/replies_web.py" || true

      - name: Summarize outputs
        id: outputs
        shell: bash
        run: |
          set -euo pipefail
          VTT="$ARTDIR/$BASE.vtt"
          EMOJI="$ARTDIR/${BASE}_emoji.vtt"
          TRANS="$ARTDIR/${BASE}_transcript.html"
          TRANS_CLEAN="$ARTDIR/${BASE}_transcript.clean.html"
          REPLIES="$ARTDIR/${BASE}_replies.html"
          LINKS="$ARTDIR/${BASE}_links.html"

          [ -f "$VTT" ] && echo "vtt_path=$VTT" >> "$GITHUB_OUTPUT" || echo "vtt_path=" >> "$GITHUB_OUTPUT"
          [ -f "$EMOJI" ] && echo "emoji_vtt_path=$EMOJI" >> "$GITHUB_OUTPUT" || echo "emoji_vtt_path=" >> "$GITHUB_OUTPUT"
          [ -f "$TRANS" ] && echo "transcript_path=$TRANS" >> "$GITHUB_OUTPUT" || echo "transcript_path=" >> "$GITHUB_OUTPUT"
          [ -f "$TRANS_CLEAN" ] && echo "transcript_clean_path=$TRANS_CLEAN" >> "$GITHUB_OUTPUT" || echo "transcript_clean_path=" >> "$GITHUB_OUTPUT"
          [ -f "$REPLIES" ] && echo "replies_path=$REPLIES" >> "$GITHUB_OUTPUT" || echo "replies_path=" >> "$GITHUB_OUTPUT"
          [ -f "$LINKS" ] && echo "links_path=$LINKS" >> "$GITHUB_OUTPUT" || echo "links_path=" >> "$GITHUB_OUTPUT"

          echo "::group::Tree"
          ls -lah "$ARTDIR" || true
          echo "::endgroup::"

      - name: Upload GitHub artifact (HTML/VTT only, no audio)
        if: ${{ inputs.upload_artifacts == true }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.init.outputs.base }}-space-worker
          path: |
            artifacts/*.vtt
            artifacts/*_transcript.html
            artifacts/*_transcript.clean.html
            artifacts/*_transcript_paragraphs.html
            artifacts/*_replies.html
            artifacts/*_links.html
            artifacts/*_genvtt.log
            artifacts/*_polish.log
            artifacts/*_replies.log
          if-no-files-found: warn
          retention-days: 21

      - name: Auth to GCP (optional)
        id: gcp-auth
        if: ${{ env.GCP_SA_KEY != '' && env.GCS_BUCKET != '' }}
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ env.GCP_SA_KEY }}

      - name: Upload to GCS (optional)
        id: gcs
        if: ${{ steps.gcp-auth.outcome == 'success' }}
        uses: google-github-actions/upload-cloud-storage@v2
        with:
          path: artifacts/
          destination: ${{ env.GCS_BUCKET }}/${{ inputs.gcs_prefix || 'spaces' }}/${{ steps.init.outputs.base }}/
          parent: false
          glob: |
            *.vtt
            *_transcript.html
            *_transcript.clean.html
            *_transcript_paragraphs.html
            *_replies.html
            *_links.html
        env:
          CLOUDSDK_CORE_PROJECT: dummy
        # expose a canonical base URL for later steps
      - name: Compute GCS base URL
        if: ${{ steps.gcp-auth.outcome == 'success' }}
        id: gcs-url
        shell: bash
        run: |
          set -euo pipefail
          BUCKET="${GCS_BUCKET}"
          PREFIX="${{ inputs.gcs_prefix || 'spaces' }}/${{ steps.init.outputs.base }}/"
          BASE_URL="https://storage.googleapis.com/${BUCKET}/${PREFIX}"
          echo "gcs_base_url=$BASE_URL" >> "$GITHUB_OUTPUT"

      - name: Bridge GCS URL to job outputs
        if: ${{ steps.gcp-auth.outcome == 'success' }}
        id: gcs
        run: echo "gcs_base_url=${{ steps.gcs-url.outputs.gcs_base_url }}" >> "$GITHUB_OUTPUT"

      - name: Publish to WordPress (optional)
        if: ${{ inputs.publish_wp == true && inputs.post_id != '' && env.WP_BASE_URL != '' && env.WP_USER != '' && env.WP_APP_PASSWORD != '' }}
        shell: bash
        run: |
          set -euo pipefail
          apt-get update -y >/dev/null 2>&1 || true
          apt-get install -y jq >/dev/null 2>&1 || true

          POST_ID="${{ inputs.post_id }}"
          BASE_URL="${{ steps.gcs-url.outputs.gcs_base_url || '' }}"

          REPLIES_FILE="$ARTDIR/${BASE}_replies.html"
          LINKS_FILE="$ARTDIR/${BASE}_links.html"
          TRANS_CLEAN="$ARTDIR/${BASE}_transcript.clean.html"
          VTT="$ARTDIR/${BASE}.vtt"
          EMOJI="$ARTDIR/${BASE}_emoji.vtt"

          replies_html=''
          links_html=''
          transcript_html=''
          vtt_url=''
          emoji_vtt_url=''

          if [ -f "$REPLIES_FILE" ]; then
            replies_html="$(jq -Rs < "$REPLIES_FILE")"
          fi
          if [ -f "$LINKS_FILE" ]; then
            links_html="$(jq -Rs < "$LINKS_FILE")"
          fi
          if [ -f "$TRANS_CLEAN" ]; then
            transcript_html="$(jq -Rs < "$TRANS_CLEAN")"
          fi

          if [ -n "$BASE_URL" ]; then
            [ -f "$VTT" ] && vtt_url="${BASE_URL}${BASE}.vtt" || true
            [ -f "$EMOJI" ] && emoji_vtt_url="${BASE_URL}${BASE}_emoji.vtt" || true
          fi

          # Build JSON payload
          # Adjust meta keys to whatever your plugin expects.
          cat > body.json <<'JSON'
          {
            "meta": {
              "ss3k_replies_html": __REPLIES__,
              "ss3k_links_html": __LINKS__,
              "ss3k_transcript_html": __TRANS__,
              "ss3k_vtt_url": "__VTT_URL__",
              "ss3k_emoji_vtt_url": "__EMOJI_URL__"
            }
          }
          JSON

          sed -i "s|__REPLIES__|${replies_html:-\"\"}|g" body.json
          sed -i "s|__LINKS__|${links_html:-\"\"}|g" body.json
          sed -i "s|__TRANS__|${transcript_html:-\"\"}|g" body.json
          sed -i "s|__VTT_URL__|${vtt_url}|g" body.json
          sed -i "s|__EMOJI_URL__|${emoji_vtt_url}|g" body.json

          curl -sS -X POST \
            -u "${WP_USER}:${WP_APP_PASSWORD}" \
            -H "Content-Type: application/json" \
            -d @body.json \
            "${WP_BASE_URL%/}/wp-json/wp/v2/posts/${POST_ID}" \
            | jq -r '.id // .message // "ok"' | sed 's/^/WP: /'

