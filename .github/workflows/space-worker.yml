name: Space Worker

on:
  workflow_dispatch:
    inputs:
      space_url:
        description: 'X/Twitter Space URL (optional if JSONL paths provided)'
        required: false
        type: string
        default: ''
      base:
        description: 'Base slug for filenames (default derived from URL or timestamp)'
        required: false
        type: string
        default: ''
      jsonl_path:
        description: 'Path to crawl JSONL (speech+events). If empty, uses artifacts/<base>.jsonl'
        required: false
        type: string
        default: ''
      replies_jsonl:
        description: 'Path to replies JSONL'
        required: false
        type: string
        default: ''
      purple_tweet_url:
        description: 'URL of the Purple Pill tweet (enables embeds)'
        required: false
        type: string
        default: ''
      post_id:
        description: 'WordPress post ID to update (optional)'
        required: false
        type: string
        default: ''
      gcs_prefix:
        description: 'GCS prefix like spaces/2025/11 (optional)'
        required: false
        type: string
        default: ''
      mode:
        description: 'What to run'
        required: true
        type: choice
        options: [full, replies-only, transcripts-only]
        default: full
      upload_artifacts:
        description: 'Upload GitHub artifact bundle'
        required: true
        type: boolean
        default: true
      publish_wp:
        description: 'Publish results to WordPress if post_id provided'
        required: true
        type: boolean
        default: false

  repository_dispatch:
    types: [ss3k.run]

concurrency:
  group: space-worker-${{ github.ref }}-${{ github.run_id }}
  cancel-in-progress: true

permissions:
  contents: read
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      ARTDIR: artifacts
      WP_BASE_URL: ${{ secrets.WP_BASE_URL }}
      WP_USER: ${{ secrets.WP_USER }}
      WP_APP_PASSWORD: ${{ secrets.WP_APP_PASSWORD }}
      GCS_BUCKET: ${{ secrets.GCS_BUCKET }}
      GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
      TWITTER_AUTHORIZATION: ${{ secrets.TWITTER_AUTHORIZATION }}
      TWITTER_AUTH_TOKEN: ${{ secrets.TWITTER_AUTH_TOKEN }}
      TWITTER_CSRF_TOKEN: ${{ secrets.TWITTER_CSRF_TOKEN }}
      TW_API_CONSUMER_KEY: ${{ secrets.TW_API_CONSUMER_KEY }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install tldextract

      - name: Normalize inputs (supports workflow_dispatch & repository_dispatch)
        id: norm
        shell: bash
        run: |
          set -euo pipefail

          get_input() {
            # prefer workflow_dispatch inputs, else repository_dispatch client_payload
            local key="$1"
            python - "$key" <<'PY'
import json, os, sys
key = sys.argv[1]
evt = json.loads(os.environ.get('GITHUB_EVENT_PATH') and open(os.environ['GITHUB_EVENT_PATH'],'r').read() or '{}')
# workflow_dispatch
inputs = evt.get('inputs') or evt.get('workflow_dispatch',{}).get('inputs') or {}
# repository_dispatch
payload = evt.get('client_payload') or {}
val = inputs.get(key, '')
if not val:
    val = payload.get(key, '')
print(val or '')
PY
          }

          SPACE_URL="$(get_input space_url)"
          BASE_IN="$(get_input base)"
          JSONL_IN="$(get_input jsonl_path)"
          REPLIES_IN="$(get_input replies_jsonl)"
          PURPLE_URL="$(get_input purple_tweet_url)"
          POST_ID="$(get_input post_id)"
          GCS_PREFIX="$(get_input gcs_prefix)"
          MODE="$(get_input mode)"
          UP_ART="$(get_input upload_artifacts)"
          PUB_WP="$(get_input publish_wp)"

          mkdir -p "$ARTDIR"

          if [ -n "$BASE_IN" ]; then
            BASE="$BASE_IN"
          elif [[ "$SPACE_URL" =~ status/([0-9]+) ]]; then
            BASE="space-${BASH_REMATCH[1]}"
          else
            BASE="space-$(date -u +%Y%m%d-%H%M%S)"
          fi

          JSONL_PATH="${JSONL_IN:-$ARTDIR/$BASE.jsonl}"
          REPLIES_JSONL="${REPLIES_IN:-$ARTDIR/${BASE}_replies.jsonl}"

          echo "BASE=$BASE" >> "$GITHUB_ENV"
          echo "JSONL_PATH=$JSONL_PATH" >> "$GITHUB_ENV"
          echo "REPLIES_JSONL=$REPLIES_JSONL" >> "$GITHUB_ENV"
          echo "PURPLE_TWEET_URL=$PURPLE_URL" >> "$GITHUB_ENV"
          echo "POST_ID=$POST_ID" >> "$GITHUB_ENV"
          echo "GCS_PREFIX=$GCS_PREFIX" >> "$GITHUB_ENV"
          echo "MODE=${MODE:-full}" >> "$GITHUB_ENV"
          echo "UPLOAD_ARTIFACTS=${UP_ART:-true}" >> "$GITHUB_ENV"
          echo "PUBLISH_WP=${PUB_WP:-false}" >> "$GITHUB_ENV"

          # Ensure files exist to keep scripts happy if you haven't uploaded them yet
          [ -f "$JSONL_PATH" ] || : > "$JSONL_PATH"
          [ -f "$REPLIES_JSONL" ] || : > "$REPLIES_JSONL"

          echo "Inputs normalized:"
          env | grep -E '^(BASE|MODE|JSONL_PATH|REPLIES_JSONL|PURPLE_TWEET_URL|POST_ID|GCS_PREFIX|UPLOAD_ARTIFACTS|PUBLISH_WP)='

      - name: Generate captions/emoji VTT + transcript
        if: ${{ env.MODE != 'replies-only' }}
        shell: bash
        run: |
          set -euo pipefail
          python ".github/workflows/scripts/gen_vtt.py"

      - name: Polish transcript HTML
        if: ${{ env.MODE != 'replies-only' }}
        shell: bash
        run: |
          set -euo pipefail
          python ".github/workflows/scripts/polish_transcript.py"

      - name: Build replies HTML + links
        if: ${{ env.MODE != 'transcripts-only' }}
        shell: bash
        run: |
          set -euo pipefail
          python ".github/workflows/scripts/replies_web.py" || true

      - name: Upload GitHub artifact (HTML/VTT only, no audio)
        if: ${{ env.UPLOAD_ARTIFACTS == 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.BASE }}-space-worker
          path: |
            artifacts/*.vtt
            artifacts/*_transcript.html
            artifacts/*_transcript.clean.html
            artifacts/*_transcript_paragraphs.html
            artifacts/*_replies.html
            artifacts/*_links.html
            artifacts/*_genvtt.log
            artifacts/*_polish.log
            artifacts/*_replies.log
          if-no-files-found: warn
          retention-days: 21

      - name: Auth to GCP (optional)
        id: gcp-auth
        if: ${{ env.GCP_SA_KEY != '' && env.GCS_BUCKET != '' }}
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ env.GCP_SA_KEY }}

      - name: Upload to GCS (optional)
        id: gcs-upload
        if: ${{ steps.gcp-auth.outcome == 'success' }}
        uses: google-github-actions/upload-cloud-storage@v2
        with:
          path: artifacts/
          destination: ${{ env.GCS_BUCKET }}/${{ env.GCS_PREFIX != '' && env.GCS_PREFIX || 'spaces' }}/${{ env.BASE }}/
          parent: false
          glob: |
            *.vtt
            *_transcript.html
            *_transcript.clean.html
            *_transcript_paragraphs.html
            *_replies.html
            *_links.html

      - name: Compute GCS base URL
        id: gcs-url
        if: ${{ steps.gcp-auth.outcome == 'success' }}
        shell: bash
        run: |
          set -euo pipefail
          PREFIX="${GCS_PREFIX:-spaces}/${BASE}/"
          BASE_URL="https://storage.googleapis.com/${GCS_BUCKET}/${PREFIX}"
          echo "gcs_base_url=$BASE_URL" >> "$GITHUB_OUTPUT"

      - name: Publish to WordPress (optional)
        if: ${{ env.PUBLISH_WP == 'true' && env.POST_ID != '' && env.WP_BASE_URL != '' && env.WP_USER != '' && env.WP_APP_PASSWORD != '' }}
        shell: bash
        run: |
          set -euo pipefail
          apt-get update -y >/dev/null 2>&1 || true
          apt-get install -y jq >/dev/null 2>&1 || true

          REPLIES_FILE="$ARTDIR/${BASE}_replies.html"
          LINKS_FILE="$ARTDIR/${BASE}_links.html"
          TRANS_CLEAN="$ARTDIR/${BASE}_transcript.clean.html"
          VTT="$ARTDIR/${BASE}.vtt"
          EMOJI="$ARTDIR/${BASE}_emoji.vtt"

          replies_html=''; links_html=''; transcript_html=''; vtt_url=''; emoji_vtt_url=''
          [ -f "$REPLIES_FILE" ] && replies_html="$(jq -Rs < "$REPLIES_FILE")"
          [ -f "$LINKS_FILE" ]   && links_html="$(jq -Rs < "$LINKS_FILE")"
          [ -f "$TRANS_CLEAN" ]  && transcript_html="$(jq -Rs < "$TRANS_CLEAN")"

          # If uploaded to GCS, produce URLs
          if [ -n "${{ steps.gcs-url.outputs.gcs_base_url || '' }}" ]; then
            BASE_URL="${{ steps.gcs-url.outputs.gcs_base_url }}"
            [ -f "$VTT" ]   && vtt_url="${BASE_URL}${BASE}.vtt"
            [ -f "$EMOJI" ] && emoji_vtt_url="${BASE_URL}${BASE}_emoji.vtt"
          fi

          cat > body.json <<JSON
          {
            "meta": {
              "ss3k_replies_html": ${replies_html:-"\"\""},
              "ss3k_links_html": ${links_html:-"\"\""},
              "ss3k_transcript_html": ${transcript_html:-"\"\""},
              "ss3k_vtt_url": "${vtt_url}",
              "ss3k_emoji_vtt_url": "${emoji_vtt_url}"
            }
          }
          JSON

          curl -sS -X POST \
            -u "${WP_USER}:${WP_APP_PASSWORD}" \
            -H "Content-Type: application/json" \
            -d @body.json \
            "${WP_BASE_URL%/}/wp-json/wp/v2/posts/${POST_ID}" \
            | jq -r '.id // .message // "ok"' | sed 's/^/WP: /'
